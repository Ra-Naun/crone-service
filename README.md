# crone-service

Важное замечание: сразу после запуска замените пароль администратора. По умолчанию логин/пароль: `admin` / `admin`.

Ниже — пошаговая инструкция с картинками, как в UI Cronicle создать джобу, которая каждые 5 минут делает POST-запрос для добивания «зависших» платежей через API провайдера.

## Что настраиваем
- URL: `http://localhost:3000/api/cron/billing/reconcile-processing`
- Method: `POST`
- Headers:
  - `x-cron-key: <CRON_SECRET>`
  - `Content-Type: application/json`
- CRON: `2-59/5 * * * *` (каждые 5 минут: 02, 07, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57)
- Назначение: добивать «зависшие» платежи через API провайдера (Renew Due)

Примечание про время: контейнер Cronicle в `docker-compose` настроен на часовой пояс `Europe/Moscow`. Если ваш часовой пояс другой, скорректируйте `TZ` в `app/docker-compose.yaml`.

---

## Шаг 1. Откройте UI и войдите
Откройте `http://localhost:3012/` в браузере и войдите под администратором.

![Шаг 1 — Вход](docs/images/01-login.svg)

Логин: `admin`, Пароль: `admin` (по умолчанию). Сразу перейдите к смене пароля (следующий шаг).

## Шаг 2. Смените пароль администратора
Откройте: Admin → Users → `admin` → Change Password. Введите новый сложный пароль и сохраните.

![Шаг 2 — Смена пароля](docs/images/02-change-password.svg)

## Шаг 3. Создайте новое событие (джобу)
Перейдите в раздел событий и нажмите «New Event».

Задайте:
- Title: `Billing • Reconcile processing (Renew Due)`
- Category: `Billing` (создайте, если её ещё нет)

![Шаг 3 — Новое событие](docs/images/03-new-event.svg)

## Шаг 4. Выберите встроенный плагин HTTP Request
В настройках события в выпадающем списке плагинов выберите `HTTP Request`.

Заполните поля:
- Method: `POST`
- URL: `http://localhost:3000/api/cron/billing/reconcile-processing`
- Headers:
  - `x-cron-key: <CRON_SECRET>` (подставьте ваш фактический секрет)
  - `Content-Type: application/json`
- Body: `{}` (пустой JSON-объект, если тело не требуется)

![Шаг 4 — HTTP Request](docs/images/04-http-plugin.svg)

Примечание по безопасности: храните секрет в закрытом месте. Если в вашей сборке Cronicle доступны «секретные параметры» или переменные, используйте их вместо хранения значения в открытом виде.

## Шаг 5. Настройте расписание (CRON)
В поле расписания укажите:

```
2-59/5 * * * *
```

Это время запуска «каждые 5 минут» в минуты 02, 07, 12, 17, 22, 27, 32, 37, 42, 47, 52, 57 в вашем часовом поясе контейнера.

![Шаг 5 — CRON-расписание](docs/images/05-cron.svg)

Рекомендации в «параметрах выполнения» (по желанию):
- Max Concurrent: `1` (не запускать параллели)
- Timeout: `60–120s` (в зависимости от API)
- Retries: `1–3`
- Catch Up / Missed runs: включить, если хотите «догонять» пропущенные запуски (аналог «Renew Due» поведения при простоях)

## Шаг 6. Сохраните и выполните пробный запуск
Сохраните событие и выполните «Run Now» для проверки. Перейдите в лог выполнения, чтобы убедиться, что запрос отработал без ошибок (код 2xx, ожидаемый ответ).

![Шаг 6 — Сохранение и запуск](docs/images/06-save-run.svg)

---

## Отладка
- 401/403: проверьте заголовок `x-cron-key` и корректность секрета.
- 404: проверьте URL и маршрут в вашем сервисе.
- Connection refused/ECONNREFUSED: убедитесь, что приложение доступно на `localhost:3000` и не блокируется фаерволом/сетью.
- Таймзона: если расписание «съезжает», проверьте `TZ` в `app/docker-compose.yaml`.
- Повторные попытки: увеличьте `Retries` и/или `Timeout` при периодических сбоях у провайдера.

## Полезно знать
- UI Cronicle доступен по `http://localhost:3012/` (см. `app/docker-compose.yaml`).
- Логи Cronicle сохраняются в тома `./logs` (см. compose-файл). Сами логи выполнения задач также доступны через UI.
